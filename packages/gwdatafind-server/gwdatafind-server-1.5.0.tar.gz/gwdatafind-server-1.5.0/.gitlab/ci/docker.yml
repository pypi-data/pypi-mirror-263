# ---------------------------
# Docker workflow
# ---------------------------

.docker:
  stage: docker
  needs: []
  image: docker:latest
  variables:
    DOCKER_BRANCH: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
    DOCKER_LATEST: $CI_REGISTRY_IMAGE:latest
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  after_script:
    - docker logout $CI_REGISTRY

docker:build:
  extends:
    - .docker
  script:
    - docker build --no-cache --pull -t $DOCKER_BRANCH .
    - docker push $DOCKER_BRANCH

docker:latest:
  extends:
    - .docker
  stage: deploy
  needs:
    - docker:build
  rules:
    - if: '$CI_PROJECT_NAMESPACE == "computing/gwdatafind" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  script:
    - docker pull $DOCKER_BRANCH
    - docker tag $DOCKER_BRANCH $DOCKER_LATEST
    - docker push $DOCKER_LATEST
