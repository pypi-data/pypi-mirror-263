# ---------------------------
# RHEL packaging workflow
# ---------------------------

include:
  # https://computing.docs.ligo.org/gitlab-ci-templates/
  - project: computing/gitlab-ci-templates
    # https://computing.docs.ligo.org/gitlab-ci-templates/rhel/
    file: rhel.yml
  # local test template
  - local: /.gitlab/ci/test.yml

# -- macros

.el:
  variables:
    EPEL: "true"

.el8:
  extends: .el
  image: igwn/base:el8-testing

.el8-build:
  extends: .el8
  image: igwn/builder:el8-testing

.el9:
  extends: .el
  image: igwn/base:el9-testing

.el9-build:
  extends: .el9
  # no igwn/builder for el9 yet,
  # see https://git.ligo.org/docker/builder/-/issues/2
  image: igwn/base:el9-testing

# -- source packages --------
#
# These jobs make src RPMs
#

.srpm:
  extends:
    # https://computing.docs.ligo.org/gitlab-ci-templates/rhel/#.rhel:srpm
    - .rhel:srpm
  stage: source packages
  needs:
    - tarball
  variables:
    TARBALL: "gwdatafind-server-*.tar.*"
  before_script:
    - !reference [".rhel:srpm", "before_script"]
    # -- hack the tarball so that the spec file matches the version
    #    from setuptools-scm
    # unpack what we need from the tarball
    - tar --file ${TARBALL} --wildcards --strip-components 1 --get gwdatafind-server*/*.spec gwdatafind-server*/PKG-INFO
    # get the package version from the Python metadata
    - PKG_VERSION=$(grep ^Version PKG-INFO | cut -d\  -f2)
    # hack the version in the spec file
    - sed -i 's|define version\( *\)\(.*\)|define unmangled_version '${PKG_VERSION}'\n%define version '${PKG_VERSION/-/+}'|' *.spec
    - sed -i 's|pypi_source|pypi_source %{srcname} %{unmangled_version}|' *.spec
  script:
    # build the SRPM from the spec file (not the tarball)
    - rpmbuild -bs
          --define "_srcrpmdir ${CI_PROJECT_DIR}"
          --define "_sourcedir ${CI_PROJECT_DIR}"
          *.spec

srpm:el8:
  extends:
    - .srpm
    - .el8-build

srpm:el9:
  extends:
    - .srpm
    - .el9-build

# -- binary packages --------
#
# These jobs generate binary RPMs
# from the src RPMs
#

.rpm:
  extends:
    # https://computing.docs.ligo.org/gitlab-ci-templates/rhel/#.rhel:rpm
    - .rhel:rpm
  stage: binary packages
  variables:
    SRPM: "python-gwdatafind-server-*.src.rpm"

rpm:el8:
  extends:
    - .rpm
    - .el8-build
  needs:
    - srpm:el8

rpm:el9:
  extends:
    - .rpm
    - .el9-build
  needs:
    - srpm:el9

# -- test -------------------

.test:el:
  extends:
    # see /.gitlab/ci/test.yml
    - .test
  before_script:
    # set up yum caching
    - !reference [".rhel:base", before_script]
    # configure EPEL
    - yum -y -q install epel-release && yum -y -q install epel-rpm-macros
    # install testing dependencies
    - PY3=$(rpm --eval '%{?python3_pkgversion:%{python3_pkgversion}}%{!?python3_pkgversion:3}')
    - yum -y -q install
          findutils
          python${PY3}-coverage
          python${PY3}-pytest
          python${PY3}-pytest-cov
    # install our package(s)
    - yum -y -q install *.rpm
  script:
    - !reference [".test", script]
    # check user was created
    - getent passwd | egrep '^gwdatafind:' || { echo "gwdatafind user not found" 2>&1; exit 1; }

# -- EL8 has python3-flask < 1.0.0
#test:el8:
#  extends:
#    - .test:el
#    - .el8
#  needs:
#    - tarball
#    - rpm:el8

test:el9:
  extends:
    - .test:el
    - .el9
  needs:
    - tarball
    - rpm:el9

# -- lint -------------------
#
# These jobs check the code
# for quality issues
#

.rpmlint:
  extends:
    # https://computing.docs.ligo.org/gitlab-ci-templates/rhel/#.rhel:lint
    - .rhel:lint
  stage: code quality

rpmlint:el8:
  extends:
    - .rpmlint
    - .el8
  needs:
    - rpm:el8

rpmlint:el9:
  extends:
    - .rpmlint
    - .el9
  needs:
    - rpm:el9
