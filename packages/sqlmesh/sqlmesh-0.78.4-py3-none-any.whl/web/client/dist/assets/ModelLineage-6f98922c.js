import{r as o,R as r,s as S,ar as je,d as ie,i as T,j as t,c as O,q as W,B as ce,aA as Ce,g as de,h as Y,P as ke,V as Ee,aB as Me,p as Se,L as ue,S as me,z as se,D as ze}from"./index-5acd2ba8.js";import{d as Le,e as he,s as ge,f as J,P as pe,h as ee,b as $,i as U,j as Ie,k as ne,M as Ae,l as Be,R as He,m as Re,n as De,o as ae,p as oe,q as le,r as Te,t as Ue,v as _e,w as Oe}from"./context-b4173517.js";import{a as We}from"./editor-aecdb12c.js";import{X as $e,L as Fe}from"./ListboxShow-9eda18e9.js";import{S as Ve}from"./SearchList-cd831fe1.js";import{z as Pe}from"./Input-8dd9b5ad.js";import{w as Q}from"./transition-4528927e.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./file-af39a160.js";import"./project-49fba595.js";function Ge({title:e,titleId:s,...n},f){return o.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:f,"aria-labelledby":s},n),e?o.createElement("title",{id:s},e):null,o.createElement("path",{fillRule:"evenodd",d:"M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z",clipRule:"evenodd"}))}const qe=o.forwardRef(Ge),Ke=qe;function Xe(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},r.createElement("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"}))}function Ze(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},r.createElement("path",{d:"M0 0h32v4.2H0z"}))}function Qe(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},r.createElement("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"}))}function Ye(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},r.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"}))}function Je(){return r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},r.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"}))}const q=({children:e,className:s,...n})=>r.createElement("button",{type:"button",className:ee(["react-flow__controls-button",s]),...n},e);q.displayName="ControlButton";const et=e=>({isInteractive:e.nodesDraggable||e.nodesConnectable||e.elementsSelectable,minZoomReached:e.transform[2]<=e.minZoom,maxZoomReached:e.transform[2]>=e.maxZoom}),fe=({style:e,showZoom:s=!0,showFitView:n=!0,showInteractive:f=!0,fitViewOptions:l,onZoomIn:a,onZoomOut:x,onFitView:u,onInteractiveChange:b,className:h,children:c,position:y="bottom-left"})=>{const g=Le(),[k,j]=o.useState(!1),{isInteractive:p,minZoomReached:w,maxZoomReached:d}=he(et,ge),{zoomIn:N,zoomOut:C,fitView:m}=J();if(o.useEffect(()=>{j(!0)},[]),!k)return null;const A=()=>{N(),a==null||a()},E=()=>{C(),x==null||x()},M=()=>{m(l),u==null||u()},v=()=>{g.setState({nodesDraggable:!p,nodesConnectable:!p,elementsSelectable:!p}),b==null||b(!p)};return r.createElement(pe,{className:ee(["react-flow__controls",h]),position:y,style:e,"data-testid":"rf__controls"},s&&r.createElement(r.Fragment,null,r.createElement(q,{onClick:A,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:d},r.createElement(Xe,null)),r.createElement(q,{onClick:E,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:w},r.createElement(Ze,null))),n&&r.createElement(q,{className:"react-flow__controls-fitview",onClick:M,title:"fit view","aria-label":"fit view"},r.createElement(Qe,null)),f&&r.createElement(q,{className:"react-flow__controls-interactive",onClick:v,title:"toggle interactivity","aria-label":"toggle interactivity"},p?r.createElement(Je,null):r.createElement(Ye,null)),c)};fe.displayName="Controls";var tt=o.memo(fe),I;(function(e){e.Lines="lines",e.Dots="dots",e.Cross="cross"})(I||(I={}));function st({color:e,dimensions:s,lineWidth:n}){return r.createElement("path",{stroke:e,strokeWidth:n,d:`M${s[0]/2} 0 V${s[1]} M0 ${s[1]/2} H${s[0]}`})}function nt({color:e,radius:s}){return r.createElement("circle",{cx:s,cy:s,r:s,fill:e})}const at={[I.Dots]:"#91919a",[I.Lines]:"#eee",[I.Cross]:"#e2e2e2"},ot={[I.Dots]:1,[I.Lines]:1,[I.Cross]:6},lt=e=>({transform:e.transform,patternId:`pattern-${e.rfId}`});function xe({id:e,variant:s=I.Dots,gap:n=20,size:f,lineWidth:l=1,offset:a=2,color:x,style:u,className:b}){const h=o.useRef(null),{transform:c,patternId:y}=he(lt,ge),g=x||at[s],k=f||ot[s],j=s===I.Dots,p=s===I.Cross,w=Array.isArray(n)?n:[n,n],d=[w[0]*c[2]||1,w[1]*c[2]||1],N=k*c[2],C=p?[N,N]:d,m=j?[N/a,N/a]:[C[0]/a,C[1]/a];return r.createElement("svg",{className:ee(["react-flow__background",b]),style:{...u,position:"absolute",width:"100%",height:"100%",top:0,left:0},ref:h,"data-testid":"rf__background"},r.createElement("pattern",{id:y+e,x:c[0]%d[0],y:c[1]%d[1],width:d[0],height:d[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${m[0]},-${m[1]})`},j?r.createElement(nt,{color:g,radius:N/a}):r.createElement(st,{dimensions:C,color:g,lineWidth:l})),r.createElement("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${y+e})`}))}xe.displayName="Background";var rt=o.memo(xe);const K={UNKNOWN:"UNKNOWN",STRUCT:"STRUCT"};function it({id:e,data:s,sourcePosition:n,targetPosition:f}){const l=s??{},{connections:a,models:x,handleClickModel:u,lineage:b,lineageCache:h,selectedNodes:c,setSelectedNodes:y,mainNode:g,withConnected:k,connectedNodes:j,highlightedNodes:p,activeNodes:w}=$(),d=o.useMemo(()=>{var te;const B=x.get(e),D=(B==null?void 0:B.columns)??[];return Object.keys(((te=b[e])==null?void 0:te.columns)??{}).forEach(P=>{const G=D.find(({name:ye})=>ye===decodeURI(P));S(G)&&D.push({name:P,type:K.UNKNOWN})}),D.forEach(P=>{let G=P.type??K.UNKNOWN;G.startsWith(K.STRUCT)&&(G=K.STRUCT),P.type=G}),D},[e,x,b]),N=o.useMemo(()=>Object.values(p).flat(),[p]),[C,m]=o.useState(!1),A=o.useCallback(B=>{B.stopPropagation(),u==null||u(e)},[u,e,s.isInteractive]),E=o.useCallback(B=>{B.stopPropagation(),!(N.includes(e)||g===e)&&y(D=>(D.has(e)?D.delete(e):D.add(e),new Set(D)))},[y,N]),M=p["*"],v=d.some(({name:B})=>a.get(je(e,B))),i=Object.keys(p).length>0,z=Object.keys(p).find(B=>p[B].includes(e)),F=g===e,L=N.includes(e),H=c.has(e),V=l.type===U.sql,_=l.type===U.cte,R=l.type===U.external,we=l.type===U.seed,X=l.type===U.unknown,Z=(v||l.withColumns||C||H||F)&&ie(d)&&T(i),be=c.size>0||w.size>0||k?H||w.has(e)||k&&j.has(e):j.has(e),Ne=g!==e&&W(u)&&T(_)&&T(X),ve=T(V);return t.jsxs("div",{onMouseEnter:()=>m(!0),onMouseLeave:()=>m(!1),className:O("text-xs font-semibold border-4",C?"z-50":"z-1",Z?"rounded-xl":"rounded-2xl",(i?L:be)||F?"opacity-100":"opacity-40 hover:opacity-100",S(z)?i?M:[_?"border-accent-500 bg-accent-500 text-accent-500 dark:border-accent-300 dark:bg-accent-300 dark:text-accent-300":X?"border-neutral-500 bg-neutral-500 text-neutral-500 dark:border-neutral-300 dark:bg-neutral-300 dark:text-neutral-300":"border-secondary-500 bg-secondary-500 text-secondary-500 dark:bg-primary-500  dark:border-primary-500 dark:text-primary-500",F?"ring-8 ring-brand-50":R||we?"ring-8 ring-accent-50":""]:z,H&&_?"ring-8 ring-accent-50":H&&X?"ring-8 ring-neutral-50":H&&"ring-8 ring-secondary-50 dark:ring-primary-50"),style:{maxWidth:S(l.width)?"auto":`${l.width}px`},children:[t.jsx(Ie,{id:e,type:l.type,label:l.label,isSelected:H,isDraggable:!0,className:O("bg-theme-lighter",Z?"rounded-t-[8px]":"rounded-xl"),hasLeft:f===ne.Left&&S(h),hasRight:n===ne.Right&&S(h),handleClick:Ne?A:void 0,handleSelect:g===e||_||i||W(h)?void 0:E,count:i?void 0:d.length}),Z&&t.jsx(Ae,{className:"max-h-[15rem] rounded-b-lg",nodeId:e,columns:d,disabled:ve,withHandles:!0,withSource:!0,withDescription:!1})]})}function ct({handleSelect:e}){const{models:s,lineage:n,mainNode:f,connectedNodes:l}=$(),[a,x]=o.useState(!1),[u,b]=o.useState([]),[h,c]=o.useState(!1);o.useEffect(()=>{b([])},[f,s,n]);function y(){x(!0)}function g(){x(!1)}function k(j){j.length<1||ie(u)||S(f)||S(n)||(c(!0),setTimeout(()=>{const p=Array.from(Be(n,f));b(Object.keys(n).map(w=>{var d;return{name:w,displayName:((d=s.get(w))==null?void 0:d.displayName)??decodeURI(w),description:`${p.includes(w)?"Upstream":"Downstream"} | ${l.has(w)?"Directly":"Indirectly"} Connected`}})),c(!1)},300))}return t.jsxs("div",{className:O("w-full",a?"block absolute top-0 left-0 right-0 z-10 pr-10 bg-light dark:bg-dark @[40rem]:items-end @[40rem]:justify-end @[40rem]:flex @[40rem]:static @[40rem]:pr-0":"items-end justify-end flex"),children:[t.jsx(ce,{shape:Ce.Circle,className:O("flex @[40rem]:hidden !py-1 border-transparent",a?"hidden":"flex"),variant:de.Alternative,size:Y.sm,"aria-label":"Show search",onClick:y,children:t.jsx(Ke,{className:"w-3 h-3 text-primary-500"})}),t.jsx(Ve,{list:u,placeholder:"Find",searchBy:"displayName",displayBy:"displayName",direction:"top",descriptionBy:"description",showIndex:!1,size:Y.sm,onSelect:e,isLoading:h,className:O("w-full @sm:min-w-[12rem] @[40rem]:flex",a?"flex max-w-none":"hidden max-w-[20rem]"),isFullWidth:!0,onInput:k}),t.jsx("button",{className:O("flex @[40rem]:hidden bg-none border-none px-2 py-1 absolute right-0 top-0",a?"flex":"hidden"),"aria-label":"Hide search",onClick:g,children:t.jsx($e,{className:"w-6 h-6 text-primary-500"})})]})}function re({nodes:e=[]}){const{setCenter:s}=J(),{activeNodes:n,models:f,mainNode:l,nodesMap:a,selectedNodes:x,setSelectedNodes:u,withImpacted:b,connectedNodes:h,lineageCache:c,setActiveEdges:y,setConnections:g,setLineage:k,setLineageCache:j}=$(),p=S(l)?void 0:f.get(l),w=n.size>0?n.size:h.size,d=x.size,N=h.size-1,C=e.filter(v=>v.hidden).length,m=e.filter(v=>T(v.hidden)&&(v.data.type===U.external||v.data.type===U.seed)).length,A=e.filter(v=>T(v.hidden)&&v.data.type===U.cte).length,E=w>0&&w!==N+1;function M(){if(S(l))return;const v=a[l];S(v)||setTimeout(()=>{s(v.position.x,v.position.y,{zoom:.5,duration:0})},200)}return t.jsxs(t.Fragment,{children:[W(p)&&t.jsx("a",{className:"mr-2 w-full whitespace-nowrap text-ellipsis overflow-hidden @lg:block font-bold text-neutral-600 dark:text-neutral-400 cursor-pointer hover:underline",onClick:M,children:ke(p.displayName,50,25)}),t.jsxs("span",{className:"bg-neutral-5 px-2 py-0.5 flex rounded-full mr-2",children:[t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"All:"})," ",e.length]}),C>0&&t.jsxs("span",{className:"whitespace-nowrap block mr-2",children:[t.jsx("b",{children:"Hidden:"})," ",C]}),d>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Selected:"})," ",d]}),E&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Active:"})," ",w]}),(E||d>0||W(c))&&t.jsx(ce,{size:Y.xs,variant:de.Neutral,format:Ee.Ghost,className:"!m-0 px-1",onClick:()=>{y(new Map),g(new Map),u(new Set),W(c)&&(k(c),j(void 0))},children:"Reset"})]}),m>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Sources"}),": ",m]}),T(E)&&b&&d===0&&N>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"Upstream/Downstream:"})," ",N]}),A>0&&t.jsxs("span",{className:"mr-2 whitespace-nowrap block",children:[t.jsx("b",{children:"CTEs:"})," ",A]})]})}const dt=30;function jt({model:e,highlightedNodes:s}){const{setActiveEdges:n,setConnections:f,setLineage:l,handleError:a,setSelectedNodes:x,setMainNode:u,setWithColumns:b,setHighlightedNodes:h,setNodeConnections:c,setLineageCache:y,setUnknownModels:g,models:k,unknownModels:j}=$(),{refetch:p,isFetching:w,cancel:d}=Me(e.name),{isFetching:N}=Se(),[C,m]=o.useState(!1),[A,E]=o.useState(void 0);o.useEffect(()=>{const i=We();return i.addEventListener("message",M),p().then(({data:z})=>{E(z),!S(z)&&(m(!0),i.postMessage({topic:"lineage",payload:{currentLineage:{},newLineage:z,mainNode:e.fqn}}))}).catch(z=>{a==null||a(z)}).finally(()=>{n(new Map),f(new Map),x(new Set),y(void 0),u(e.fqn)}),()=>{d==null||d(),i.removeEventListener("message",M),i.terminate(),l({}),c({}),u(void 0),h({})}},[e.hash]),o.useEffect(()=>{Object.keys(A??{}).forEach(i=>{i=encodeURI(i),T(k.has(i))&&T(j.has(i))&&j.add(i)}),g(new Set(j))},[A,k]),o.useEffect(()=>{h(s??{})},[s]);function M(i){var z;i.data.topic==="lineage"&&(m(!1),c(i.data.payload.nodesConnections),l(i.data.payload.lineage),Object.values(((z=i.data.payload)==null?void 0:z.lineage)??{}).length>dt&&b(!1)),i.data.topic==="error"&&(a==null||a(i.data.error),m(!1))}const v=w||N||C;return t.jsxs("div",{className:"relative h-full w-full overflow-hidden",children:[v&&t.jsxs("div",{className:"absolute top-0 left-0 z-10 flex justify-center items-center w-full h-full",children:[t.jsx("span",{className:"absolute w-full h-full z-10 bg-transparent-20 backdrop-blur-lg"}),t.jsxs(ue,{className:"inline-block z-10",children:[t.jsx(me,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md whitespace-nowrap",children:v?"Loading Model's Lineage...":"Merging Model's..."})]})]}),t.jsx(He,{children:t.jsx(ut,{})})]})}function ut(){const{withColumns:e,lineage:s,mainNode:n,selectedEdges:f,selectedNodes:l,withConnected:a,withImpacted:x,withSecondary:u,hasBackground:b,activeEdges:h,connectedNodes:c,connections:y,nodesMap:g,showControls:k,handleError:j,setActiveNodes:p}=$(),{setCenter:w}=J(),[d,N]=o.useState(!1),C=o.useMemo(()=>({model:it}),[]),m=o.useMemo(()=>Re(s),[s]),A=o.useMemo(()=>De(s),[s]),[E,M]=o.useState([]),[v,i]=o.useState([]);o.useEffect(()=>{if(se(m)||S(n))return;N(!0);const L=ae(m,h,f,g),H=oe(Object.values(g),L,n,c,l,y,a,x,u),V=le(m,y,h,L,f,l,c,a,x,u),_=Te({nodesMap:g,nodes:H,edges:V});return _.create().then(R=>{i(R.edges),M(R.nodes)}).catch(R=>{j==null||j(R),i([]),M([])}).finally(()=>{const R=S(n)?void 0:g[n];W(R)&&w(R.position.x,R.position.y,{zoom:.5,duration:0}),setTimeout(()=>{N(!1)},100)}),()=>{_.terminate(),i([]),M([])}},[h,g,A]),o.useEffect(()=>{if(S(n)||se(E))return;const L=ae(m,h,f,g),H=oe(E,L,n,c,l,y,a,x,u),V=le(m,y,h,L,f,l,c,a,x,u);i(V),M(H),p(L)},[y,g,m,h,l,f,c,a,x,u,e,n]);function z(L){M(_e(L,E))}function F(L){i(Oe(L,v))}return t.jsxs(t.Fragment,{children:[d&&t.jsxs("div",{className:"absolute top-0 left-0 z-10 flex justify-center items-center w-full h-full",children:[t.jsx("span",{className:"absolute w-full h-full z-10 bg-transparent-20 backdrop-blur-lg"}),t.jsxs(ue,{className:"inline-block z-10",children:[t.jsx(me,{className:"w-3 h-3 border border-neutral-10 mr-4"}),t.jsx("h3",{className:"text-md whitespace-nowrap",children:"Building Lineage..."})]})]}),t.jsxs(Ue,{nodes:E,edges:v,nodeTypes:C,onNodesChange:z,onEdgesChange:F,nodeOrigin:[.5,.5],minZoom:.05,maxZoom:1.5,snapGrid:[16,16],snapToGrid:!0,children:[k&&t.jsxs(pe,{position:"top-right",className:"bg-theme !m-0 w-full !z-10",children:[t.jsx(mt,{nodes:E}),t.jsx(ze,{})]}),t.jsx(tt,{className:"bg-light p-1 rounded-md !border-none !shadow-lg"}),t.jsx(rt,{variant:I.Cross,gap:32,size:4,className:O(b?"opacity-100 stroke-neutral-200 dark:stroke-neutral-800":"opacity-0")})]})]})}function mt({nodes:e=[]}){const{withColumns:s,mainNode:n,selectedNodes:f,withConnected:l,withImpacted:a,withSecondary:x,hasBackground:u,activeNodes:b,highlightedNodes:h,setSelectedNodes:c,setWithColumns:y,setWithConnected:g,setWithImpacted:k,setWithSecondary:j,setHasBackground:p}=$(),w=o.useRef(null),d=o.useMemo(()=>Object.values(h??{}).flat(),[h]);function N(C){d.includes(C.name)||n===C.name||c(m=>(m.has(C.name)?m.delete(C.name):m.add(C.name),new Set(m)))}return t.jsxs("div",{className:"px-2 flex items-center text-xs text-neutral-400 @container",children:[t.jsxs("div",{className:"contents",children:[t.jsxs(Q,{className:"flex @lg:hidden bg-none border-none","aria-label":"Show lineage node details",children:[t.jsxs(Q.Button,{ref:w,className:"flex items-center relative w-full cursor-pointer bg-primary-10 text-xs rounded-full text-primary-500 py-1 px-3 text-center focus:outline-none focus-visible:border-accent-500 focus-visible:ring-2 focus-visible:ring-light focus-visible:ring-opacity-75 focus-visible:ring-offset-2 focus-visible:ring-offset-brand-300 border-1 border-transparent",children:["Details",t.jsx(Pe,{className:"ml-2 h-4 w-4","aria-hidden":"true"})]}),t.jsx(Q.Panel,{className:"absolute left-2 right-2 flex-col z-50 mt-8 transform flex px-4 py-3 bg-theme-lighter shadow-xl focus:ring-2 ring-opacity-5 rounded-lg",children:t.jsx(re,{nodes:e})})]}),t.jsx("div",{className:"hidden @lg:contents w-full",children:t.jsx(re,{nodes:e})})]}),t.jsxs("div",{className:"flex w-full justify-end items-center",children:[t.jsx(ct,{handleSelect:N}),t.jsx(Fe,{options:{Background:p,Columns:b.size>0&&f.size===0?void 0:y,Connected:b.size>0?void 0:g,"Upstream/Downstream":b.size>0?void 0:k,All:b.size>0?void 0:j},value:[s&&"Columns",u&&"Background",l&&"Connected",a&&"Upstream/Downstream",x&&"All"].filter(Boolean)})]})]})}export{jt as default};
