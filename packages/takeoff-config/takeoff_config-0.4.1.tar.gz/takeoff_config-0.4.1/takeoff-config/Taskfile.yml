version: '3'

tasks:
  # ------------------------------------------- Default -------------------------------------------- #
  print-format:
    desc: "Print formatted message"
    vars:
      MESSAGE: '{{default "HI" .MESSAGE}}'
    cmds:
      - echo -e '{{.SEP_LINE}}\n───{{.MESSAGE}}\n{{.SEP_LINE}}'
    internal: true

  # ------------------------------------------- Setup ---------------------------------------------- #
  install-deps:
    desc: "Install the python package."
    cmds:
      - pip install maturin
      - pip install -r requirements_test.txt

  # ------------------------------------------- Testing -------------------------------------------- #

  test:
    desc: "Run unit tests for the compiled python package."
    deps:
      - install-deps
    cmds:
      - pytest tests/unit/ -vv

  # ------------------------------------------- Release -------------------------------------------- #

  release:
    desc: "Release takeoff config with Maturin."
    vars:
      PYPI_API_KEY: '{{.PYPI_API_KEY}}'
    deps:
      - install-deps
      - test
    cmds:
      - task: print-format
        vars: { MESSAGE: "Building and releasing takeoff-config ensure you have the correct credentials stored at ~/.pypirc..." }
      - python scripts/bump_version.py
      - maturin publish -u __token__ -p {{.PYPI_API_KEY}}
